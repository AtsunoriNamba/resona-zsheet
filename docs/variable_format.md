# Zoho置き換え変数書式ドキュメント

## 基本書式

置き換え変数は `<Z%変数名%Z>` の形式で記述します。

## 変数の種類

### 1. 基本フィールド参照
- 書式: `<Z%フィールド名%Z>`
- 説明: 現在のレコードの指定されたフィールドの値を参照します
- 例: `<Z%商談名%Z>`

### 2. ルックアップフィールド参照
- 書式: `<Z%ルックアップフィールド名->参照先フィールド名%Z>`
- 説明: ルックアップフィールドを通じて参照先レコードのフィールドを参照します
- 例: `<Z%取引先名->会社名%Z>`
- 特記事項:
  - Owner（所有者）フィールドの場合: `<Z%Owner->full_name%Z>`
  - Account_Name（取引先）フィールドの場合: `<Z%Account_Name->会社名%Z>`
  - その他のルックアップフィールドの場合: `<Z%ルックアップフィールド->参照先フィールド%Z>`

### 3. 関連レコード参照
- 書式: `<Z%関連リスト名@->フィールド名%Z>`
- 説明: 関連リストを通じて関連レコードのフィールドを参照します
- 例: `<Z%商談@->商品名%Z>`
- 注意: 
  - 複数の関連レコードが存在する場合、すべての値が取得されます
  - 複数レコードは、置き換え変数のある行と同じリピートキー（1列目の値）を持つ行に展開されます
  - 同じリピートキーを持つ行がない場合、その値は展開されません

### 4. サブフォーム参照
- 書式: `<Z%サブフォーム名#->フィールド名%Z>`
- 説明: サブフォーム内のフィールドを参照します
- 例: `<Z%明細#->金額%Z>`
- 注意: 
  - サブフォーム内の全レコードの値が取得されます
  - 複数レコードは、置き換え変数のある行と同じリピートキー（1列目の値）を持つ行に展開されます
  - 同じリピートキーを持つ行がない場合、その値は展開されません

### 5. 条件付き置き換え
- 書式: `<Z%フィールド名??条件式%Z>`
- 説明: 条件が真の場合のみ値を表示します
- 条件式の演算子:
  - `=`: 等しい
  - `&&`: AND条件
  - `||`: OR条件
- 例: `<Z%商談名??ステータス=確定%Z>`

### 6. 特殊変数

#### 実行日時
- 書式: `<Z%+実行日時->フォーマット%Z>`
- 説明: 現在の日時を指定されたフォーマットで表示します
- 例: `<Z%+実行日時->YYYY/MM/DD%Z>`

#### スタンプ
- 書式: `<Z%+スタンプ%Z>`
- 説明: 文書の状態に応じて以下の値を表示します
  - 再発行の場合: "再発行"
  - 訂正版の場合: "訂正版"
  - 再発行訂正版の場合: "再発行訂正版"

#### 自社インボイス登録番号
- 書式: `<Z%+自社インボイス登録番号->会社コード%Z>`
- 説明: 指定された会社コードに対応するインボイス登録番号を表示します

## リピートキーの書式

リピートキーは、シート内で繰り返し行を制御するために使用されます。

### 基本ルール
- リピートキーは1列目に記載することができます（必須ではありません）
- リピートキーは連続している必要はありません
- 異なるリピートキーが混在することができます
- 関連リストやサブフォームの置き換え変数がある行と同じリピートキーを持つ行は、関連リストやサブフォームの展開先として使用されます

### 最小行数の制御
- デフォルト: キーの末尾に数字がない場合、最小5行が確保されます
- キーの末尾に数字を付けることで、その数の最小行を確保します
  - 例: `明細10` → 最小10行を確保
  - 例: `明細3` → 最小3行を確保
  - 例: `備考1` → 最小1行を確保
- 2桁以上の数字も指定可能です
  - 例: `明細20` → 最小20行を確保

### 行の削除制御
- リピートキーが存在する行のみが削除対象となります
- リピートキーがない行は削除対象外となり、常に保持されます
- 削除の判定基準：
  1. リピートキーが存在する行で
  2. 置換前（original）と置換後のコンテンツが変更されていない場合
  3. その行は削除対象となります
- 削除の処理：
  1. 各行を個別に判定
  2. 削除対象となった行を降順（シートの下から）に処理
  3. 連続する削除対象行はまとめて削除

### 例
```
明細    <- リピートキー（最小5行）
項目A   <- リピートキーなし（制御対象外）
明細    <- 関連リスト/サブフォームの2レコード目がここに展開
項目B   <- リピートキーなし（制御対象外）
明細    <- 関連リスト/サブフォームの3レコード目がここに展開
備考10  <- 別のリピートキー（最小10行）
明細    <- 最初のリピートキーと同じ
備考10  <- 2つ目のリピートキーと同じ
```

## データ型の扱い

- 日時フィールド: `YYYY/MM/DD HH:mm:ss` 形式で表示
- 日付フィールド: `YYYY/MM/DD` 形式で表示
- ルックアップフィールド: 関連レコードの名前フィールドを表示
- null値: 空白として表示

## 注意事項

1. 関連レコードやサブフォームの参照時、複数のレコードは同じリピートキーを持つ行に展開されます
2. 条件式で使用できる演算子は `=`、`&&`、`||` のみです
3. 存在しないフィールドを参照した場合や、データの取得に失敗した場合は空白が表示されます
4. ルックアップフィールドを参照する場合、参照先のモジュールが適切に設定されている必要があります
5. 1列目にリピートキーがない行は、行の削除や展開の制御対象外となります
6. 異なるリピートキーが混在可能で、それぞれが独立して制御されます
